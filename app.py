# app.py
from flask import Flask, render_template, request, jsonify
from scanner import nmap_scanner, vulnerability_scanner
from scanner.utils import is_valid_ip

app = Flask(__name__)

# Create an instance of VulnerabilityScanner
vulnerability_scanner_instance = vulnerability_scanner.VulnerabilityScanner()

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/scan', methods=['POST'])
def scan_device():
    try:
        ip_address = request.form['ip_address']

        # Validate IP address format
        if not is_valid_ip(ip_address):
            raise ValueError("Invalid IP address format")

        # Perform Nmap scan
        nmap_results = nmap_scanner.scan_device(ip_address)

        # Perform vulnerability scan using CVE Search API
        vulnerabilities = vulnerability_scanner_instance.scan_vulnerabilities(ip_address)

        return jsonify({
            'success': True,
            'nmap_results': nmap_results,
            'vulnerabilities': vulnerabilities
        })
    except Exception as e:
        error_message = f"Error scanning {ip_address}: {str(e)}"
        return jsonify({
            'success': False,
            'error': error_message
        })

if __name__ == '__main__':
    app.run(debug=True)
