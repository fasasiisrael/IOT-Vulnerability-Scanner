$(document).ready(function() {
    $('#scan-form').submit(function(event) {
        event.preventDefault();
        var ip_address = $('#ip_address').val();
        $('#error-message').text('');

        if (!isValidIpAddress(ip_address)) {
            $('#error-message').text('Invalid IP address format');
            return;
        }

        // Show loading icon while waiting for response
        $('#loading-icon').show();

        $.ajax({
            type: 'POST',
            url: '/scan',
            data: { ip_address: ip_address },
            success: function(response) {
                // Hide loading icon once response is received
                $('#loading-icon').hide();

                if (response.success) {
                    displayScanResults(response);
                } else {
                    $('#error-message').text(response.error);
                }
            },
            error: function(xhr, status, error) {
                // Hide loading icon in case of error
                $('#loading-icon').hide();
                $('#error-message').text('Error scanning device. Please try again.');
            }
        });
    });

    function isValidIpAddress(ip_address) {
        var parts = ip_address.split('.');
        if (parts.length !== 4) {
            return false;
        }
        for (var i = 0; i < parts.length; i++) {
            if (isNaN(parts[i]) || Number(parts[i]) < 0 || Number(parts[i]) > 255) {
                return false;
            }
        }
        return true;
    }

    function displayScanResults(response) {
        $('#device-ip').text(response.nmap_results.ip_address);

        var osInfoHtml = '<h3>Operating System Information:</h3><ul>';
        response.nmap_results.os_info.forEach(function(os) {
            osInfoHtml += '<li>' + os.name + ' (Accuracy: ' + os.accuracy + ')</li>';
        });
        osInfoHtml += '</ul>';
        $('#os-info').html(osInfoHtml);

        var openPortsHtml = '<h3>Open Ports:</h3><ul>';
        response.nmap_results.open_ports.forEach(function(port) {
            openPortsHtml += '<li>' + port[0] + ' (' + port[1] + ')</li>';
        });
        openPortsHtml += '</ul>';
        $('#open-ports').html(openPortsHtml);

        if (response.vulnerabilities.length > 0) {
            var vulnerabilitiesHtml = '<h3>Vulnerabilities:</h3><ul>';
            response.vulnerabilities.forEach(function(vuln) {
                vulnerabilitiesHtml += '<li>' + vuln.title + ' (CVSS Score: ' + vuln.cvss + ')</li>';
            });
            vulnerabilitiesHtml += '</ul>';
            $('#vulnerabilities').html(vulnerabilitiesHtml);
        }

        $('#scan-results').show();
    }
});
