import nmap
from scanner.utils import is_valid_ip

def scan_device(ip_address):
    if not is_valid_ip(ip_address):
        raise ValueError("Invalid IP address format")

    nm = nmap.PortScanner()
    nm.scan(ip_address, arguments='-O -sV')

    if nm.all_hosts():
        host_info = nm[ip_address]
        os_info = host_info['osmatch']
        open_ports = [(port, nm[ip_address]['tcp'][port]['name']) for port in nm[ip_address]['tcp'].keys() if nm[ip_address]['tcp'][port]['state'] == 'open']
        return {
            'ip_address': ip_address,
            'os_info': os_info,
            'open_ports': open_ports
        }
    else:
        raise Exception("No hosts found or host is down")
