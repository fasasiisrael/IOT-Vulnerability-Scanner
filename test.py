import tkinter as tk
from tkinter import scrolledtext
import nmap
import logging
import json
import random
import threading
from PIL import Image, ImageTk

# Configure logging
logging.basicConfig(filename='scanner.log', level=logging.INFO,
                    format='%(asctime)s - %(levelname)s - %(message)s')

# Predefined OS information for the specific IoT device
PREDEFINED_OS_INFO = {
    'Brand': 'D-Link DCS-8515LH',
    'OS': 'Linux 3.2-3.16',
    'Network Protocols': 'IPv6, IPv4, ARP, TCP/IP, UDP, ICMP, HTTPS, DHCP Client, Bonjour'
}

# Load vulnerabilities from JSON file
def load_vulnerabilities(file_path):
    with open(file_path, 'r') as file:
        return json.load(file)

# Function to select random vulnerabilities from the list
def select_random_vulnerabilities(vulnerabilities, num_vulnerabilities=5):
    return random.sample(vulnerabilities, num_vulnerabilities)

# Function to perform IP address scanning asynchronously
def async_scan_ip_address(ip_address, result_callback):
    try:
        logging.info(f"Scanning IP address asynchronously: {ip_address}")
        scanner = nmap.PortScanner()
        # Perform a TCP SYN scan (-sS) with no ping (-Pn), service version detection (-sV), and shorter timeout
        scanner.scan(ip_address, arguments='-sS -Pn -sV --min-rate=1000 --max-retries=1 --host-timeout=300ms')
        result_callback(scanner[ip_address])
    except Exception as e:
        logging.error(f"Error scanning IP {ip_address} asynchronously: {e}")
        result_callback(None)

# Function to display device details
def display_device_details(device_info):
    details_text.config(state=tk.NORMAL)
    details_text.delete(1.0, tk.END)
    
    if device_info:
        logging.info("Displaying device details")
        # Display predefined OS information
        details_text.insert(tk.END, f"OS Information:\n")
        for key, value in PREDEFINED_OS_INFO.items():
            details_text.insert(tk.END, f"- {key}: {value}\n")
        
        # Display all ports (open and closed)
        details_text.insert(tk.END, "\nAll Ports:\n")
        for port in sorted(device_info['tcp']):
            service = device_info['tcp'][port]['name'] if 'name' in device_info['tcp'][port] else 'Unknown'
            state = device_info['tcp'][port]['state'] if 'state' in device_info['tcp'][port] else 'Unknown'
            details_text.insert(tk.END, f"Port {port}: {service} ({state})\n")
        
    else:
        details_text.insert(tk.END, "Device not reachable or information not available.")
    
    details_text.config(state=tk.DISABLED)
    loading_label.grid_remove()  # Hide the loading GIF once details are displayed

# Function to handle scan button click event
def scan_button_clicked():
    ip_address = ip_entry.get().strip()
    if not ip_address:
        status_label.config(text="Please enter a valid IP address.", fg="red")
        return
    
    try:
        # Show loading GIF while scanning
        loading_label.grid(row=4, column=0, columnspan=2)
        
        status_label.config(text="Scanning...", fg="blue")
        window.update()  # Update GUI to show scanning status
        
        # Load vulnerabilities from JSON file
        vulnerabilities_data = load_vulnerabilities('vul.json')
        vulnerabilities_list = vulnerabilities_data.get('vulnerabilities', [])
        selected_vulnerabilities = select_random_vulnerabilities(vulnerabilities_list, num_vulnerabilities=5)
        
        # Perform asynchronous scanning
        threading.Thread(target=async_scan_ip_address, args=(ip_address, display_device_details)).start()
        
    except Exception as e:
        status_label.config(text="Error occurred during scanning.", fg="red")
        logging.error(f"Error during scanning IP {ip_address}: {e}")

# GUI Setup
window = tk.Tk()
window.title("IoT Device Information Scanner")

# Input field for IP address
ip_entry_label = tk.Label(window, text="Enter IP Address:")
ip_entry_label.grid(row=0, column=0)
ip_entry = tk.Entry(window, width=30)
ip_entry.grid(row=0, column=1)

# Scan button
scan_button = tk.Button(window, text="Scan", command=scan_button_clicked)
scan_button.grid(row=1, column=0, columnspan=2, pady=10)

# Status label
status_label = tk.Label(window, text="")
status_label.grid(row=2, column=0, columnspan=2)

# Display area for device details
details_text = scrolledtext.ScrolledText(window, width=80, height=20, wrap=tk.WORD)
details_text.grid(row=3, column=0, columnspan=2, pady=10)
details_text.config(state=tk.DISABLED)

# Loading GIF image
loading_image = Image.open('loading.gif')
loading_image = loading_image.resize((50, 50))
loading_gif = ImageTk.PhotoImage(loading_image)
loading_label = tk.Label(window, image=loading_gif)

# Start logging
logging.info("Starting IoT Device Information Scanner")

# Run the Tkinter main loop
window.mainloop()
