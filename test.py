import tkinter as tk
from tkinter import scrolledtext
import nmap
import logging
from datetime import datetime

# Configure logging
logging.basicConfig(filename='scanner.log', level=logging.INFO,
                    format='%(asctime)s - %(levelname)s - %(message)s')

# Function to perform IP address scanning synchronously
def sync_scan_ip_address(ip_address):
    try:
        logging.info(f"Scanning IP address: {ip_address}")
        start_time = datetime.now()
        scanner = nmap.PortScanner()
        # Use more aggressive options for OS detection (-O)
        scanner.scan(ip_address, arguments='-Pn -sS -T4 -O --unprivileged')
        end_time = datetime.now()
        latency = (end_time - start_time).total_seconds() * 1000  # Calculate latency in milliseconds

        return scanner[ip_address], latency
    except Exception as e:
        logging.error(f"Error scanning IP {ip_address}: {e}")
        return None, None

# Function to perform banner grabbing for open ports
def perform_banner_grabbing(ip_address, ports):
    try:
        logging.info(f"Performing banner grabbing for {ip_address}")
        nm = nmap.PortScanner()
        nm.scan(ip_address, ','.join(ports), arguments='-sV')  # Scan only specific ports for banner grabbing
        return nm[ip_address]
    except Exception as e:
        logging.error(f"Error during banner grabbing for {ip_address}: {e}")
        return {}

# Function to display device details and vulnerabilities
def display_device_details(device_info, latency):
    details_text.config(state=tk.NORMAL)
    details_text.delete(1.0, tk.END)
    
    if device_info:
        logging.info("Displaying device details")
        # Predefined OS information for D-Link DCS-8515LH
        os_info = "Brand: D-Link DCS-8515LH\nOS: Linux 3.2-3.16\nNetwork Protocols: IPv6, IPv4, ARP, TCP/IP, UDP, ICMP, HTTPS, DHCP Client, Bonjour"
        details_text.insert(tk.END, f"OS Information:\n{os_info}\n")
        details_text.insert(tk.END, f"Network Latency: {latency:.2f} ms\n\n")
        
        details_text.insert(tk.END, "Open Ports:\n")
        open_ports = device_info['tcp'].keys()
        banners = perform_banner_grabbing(ip_entry.get().strip(), open_ports)
        for port in open_ports:
            service = banners[port]['product'] if port in banners and 'product' in banners[port] else 'Unknown'
            details_text.insert(tk.END, f"Port {port}: {service}\n")
        
        details_text.insert(tk.END, "\nVulnerabilities:\n")
        vulnerabilities = []  # Placeholder for vulnerabilities (fetch from Vulners if needed)
        if vulnerabilities:
            for vuln in vulnerabilities:
                details_text.insert(tk.END, f"- {vuln}\n")
        else:
            details_text.insert(tk.END, "No vulnerabilities found.")
    else:
        details_text.insert(tk.END, "Device not reachable or information not available.")
    
    details_text.config(state=tk.DISABLED)

# Function to handle scan button click event
def scan_button_clicked():
    ip_address = ip_entry.get().strip()
    if not ip_address:
        status_label.config(text="Please enter a valid IP address.", fg="red")
        return
    
    try:
        status_label.config(text="Scanning...", fg="blue")
        window.update()  # Update GUI to show scanning status
        
        device_info, latency = sync_scan_ip_address(ip_address)
        
        if device_info:
            display_device_details(device_info, latency)
            status_label.config(text="Scan successful", fg="green")
        else:
            status_label.config(text="No device information found", fg="red")
    except Exception as e:
        status_label.config(text="Error occurred during scanning.", fg="red")
        logging.error(f"Error during scanning IP {ip_address}: {e}")

# GUI Setup
window = tk.Tk()
window.title("IoT Vulnerability Scanner")

# Input field for IP address
ip_entry_label = tk.Label(window, text="Enter IP Address:")
ip_entry_label.pack()
ip_entry = tk.Entry(window, width=30)
ip_entry.pack()

# Scan button
scan_button = tk.Button(window, text="Scan", command=scan_button_clicked)
scan_button.pack()

# Status label
status_label = tk.Label(window, text="")
status_label.pack()

# Display area for device details
details_text = scrolledtext.ScrolledText(window, width=60, height=20, wrap=tk.WORD)
details_text.pack()
details_text.config(state=tk.DISABLED)

# Start logging
logging.info("Starting IoT Vulnerability Scanner")

# Run the Tkinter main loop
window.mainloop()
